<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="https://{{ip_port}}/leaflet.rotatedMarker.js"> </script>
    <script src="https://{{ip_port}}/axios.min.js"> </script> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
		#map {
			display:inline-block;
			height: 100%;
			width: 50%;
		}
		#rightHalfSide {
			display:inline-block;
			height: 100%;
			width: auto;
		}
		#camera {
			display:inline-block;
			position: absolute;
			height: 100%;
			width: 49.8%;
		}
		#lowerRightCorner {
            position: absolute;
            top: 99%;
            left:99%;
            transform: translate(-100%, -100%);
		}
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="rightHalfSide">
		<img id="camera" src="https://{{ip_port}}/stream.mjpg"/> 
		<div id="lowerRightCorner">
            <svg id="rightCornerSVG" style="border: 1px solid white;">
                <circle id="rightCornerCross" r="3" fill="white" />
                <circle id="gradienter" opacity=".3" r="10" stroke="white" stroke-width="3" fill="red" />
                Sorry, your browser does not support inline SVG.
            </svg>
		</div>
	</div>
<script> 
	var rightCornerBase = 50; 
	document.getElementById("rightCornerSVG").setAttribute("height", 2*rightCornerBase+"px"); 
	document.getElementById("rightCornerSVG").setAttribute("width" , 2*rightCornerBase+"px");  
	document.getElementById("rightCornerCross").setAttribute("transform", "translate("+rightCornerBase+","+rightCornerBase+")"); 
	document.getElementById("gradienter").setAttribute("transform", "translate("+rightCornerBase+","+rightCornerBase+")");   
</script>
<script> 
    var map = L.map('map').setView([40.730481, -73.995499], 13);
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        id: 'mapbox.streets'
    }).addTo(map);
    var homeIcon = L.icon({
        iconUrl: 'https://{{ip_port}}/home.png', 
        iconSize: [32, 32],
        iconAnchor: [3, 29],
        popupAnchor: [0, -35]
    });  
    var arrowIcon = L.icon({
        iconUrl: 'https://{{ip_port}}/arrow.png', 
        iconSize: [16, 32], // width, height
        iconAnchor: [8, 16],
    });
	console.log("{{username}}" , "{{password}}" );
    var roverLayer;
    var newestTimestampAtClientSide = "newcomer";
    var updateTimer;  // update the map every few seconds
    var stopTimer;    // if we cannot get new GPS position in a while, stop update the map.
	function gradienter(response) {
		if (response.data.z > 90 || response.data.z < -90) {
			document.getElementById("rightCornerCross").setAttribute("r", rightCornerBase); 
			document.getElementById("gradienter").setAttribute("opacity", 0); 
		} else {
			document.getElementById("gradienter").setAttribute("cx", response.data.z);
			document.getElementById("gradienter").setAttribute("cy", response.data.y); 
		}; 
	};
    function updater() {
		axios.get('https://{{ip_port}}/sensor',  {
				params: {'q': newestTimestampAtClientSide}, 
				auth: {"username": "{{username}}" , "password": "{{password}}" }
			}).then(response => {
                console.log(response.data); 
                if (newestTimestampAtClientSide == "newcomer") {
					if (response.data.newestTimestampAtServerSide == "newcomer") { 
						console.log("no GPS data"); 
					} else { // Vaild GPS data is coming  
						L.marker(response.data.HomeSpot, {icon: homeIcon}).addTo(map);
						newestTimestampAtClientSide = response.data.newestTimestampAtServerSide;
						gradienter(response);
						console.log("HomeSpot"); 
					}
				} else if (newestTimestampAtClientSide == response.data.newestTimestampAtServerSide) {
					console.log("no new GPS data");
				} else { 
                    if (typeof roverLayer != "undefined") { map.removeLayer(roverLayer); }; // 
                    roverLayer = L.marker(response.data.CurrentSpot, {icon: arrowIcon, rotationAngle: response.data.x});
                    roverLayer.addTo(map); 
					L.geoJSON(response.data.trail).addTo(map);		
					Tracking();	 
					newestTimestampAtClientSide = response.data.newestTimestampAtServerSide	
				}   
            })
    };
    function Tracking() {
		console.log("Tracking");
        //document.getElementById("restartButton").innerHTML="Tracking ...";
		if (typeof updateTimer != "undefined") { clearInterval(updateTimer); }
		if (typeof stopTimer   != "undefined") { clearTimeout( stopTimer); } 
        updateTimer = setInterval(updater, 3000); // update every 3 sec
        stopTimer = setTimeout(function () {
            clearInterval(updateTimer); 
            alert("Tracking stopped after no new GPS position in 60s ~");
        }, 600000); // stop if 1 min
    };
    Tracking();
</script>
</body>
</html>
